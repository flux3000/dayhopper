<!DOCTYPE html>
<html>
<head>
    <title>IO Lab - Memex</title>
    
    <!-- link to css file -->
    <link rel="stylesheet" type="text/css" href="_css/reset.css" />
    <link rel="stylesheet" type="text/css" href="_css/style.css" />
    <style>
        #sortable1, #sortable2 { list-style-type: none; margin: 0; padding: 0 0 2.5em; float: left; margin-right: 10px; width: 320px;}
        #sortable1 li, #sortable2 li { margin: 0 5px 5px 5px; padding: 5px; font-size: 1.2em;}
    </style>

    <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <!-- link to javascript files -->
    <script src="_js/jquery-1.10.2.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <script src="_js/script.js"></script>    
    <script type="text/javascript">
        $(document).ready(function() {
            // prepopulate trail name field
            var inputTrailName = getUrlVars()["t"];
            $("#trailName").val(inputTrailName);


            //$.getJSON("https://dantsai:npoc3opDL@api.delicious.com/v1/tags/rename?callback=?old=mytrail&new=hahaha",
            $.getJSON("http://feeds.delicious.com/v2/json/dantsai?count=100&callback=?", function(data) {
                $.each(data, function(i, item){
                    var title = item.d;
                    var url = item.u;
                    var date = item.dt;
                    $("#sortable2").append('<li><a href="'+url+'">'+title+'</a> <time>'+niceTime(date)+'<time></li>');
                });

                $(".ajax-loader").css("display","none");
            });

            $( "#sortable1, #sortable2" ).sortable({
                connectWith: ".connectedSort"
            }).disableSelection();

            $("#createTrail").submit(function(event) {
                //event.preventDefault();

                // iterate through each bookmark in sortable1
                $("#sortable1").children().each(function(index) {
                    var url = $(this).children().first().attr("href");
                    var trailname = $("#trailName").val();
                    var index2 = index+1;
                    var tags;
                    // get existing bookmark's tags

                    var jqxhr = $.get("delicious_proxy.php",
                        {username: 'dantsai', password: 'npoc3opDL', method: 'posts/get', url: url}
                    )
                    .done (function(data) {
                        tags = $(data.xml).contents().attr("tag").replace(/ /g,",");
                        // alert("tags before: " + tags);
                        tags = tags + "," + trailname + "," + trailname + "-step" + index2; 
                        // alert("tags after: " + tags);
                        $.get("delicious_proxy.php",
                            {username: 'dantsai', password: 'npoc3opDL', method: 'posts/add', url: url, tags: tags, replace: 'yes'}
                        )
                        .done (function(data) { 
                            $("#submitStatus").html("updated!");

                            // Also tag the new trail name to the Dummy
                            var jqxhr = $.get("delicious_proxy.php",
                                {username: 'dantsai', password: 'npoc3opDL', method: 'posts/get', url: "www.tripadvisor.com"}
                            )
                            .done (function(data) {
                                tags = $(data.xml).contents().attr("tag").replace(/ /g,",");
                                var tagarr = tags.split(",");
                                if($.inArray(trailname, tagarr) == -1) {
                                    tags = tags + "," + trailname; 
                                    // alert("tags after: " + tags);
                                    $.get("delicious_proxy.php",
                                        {username: 'dantsai', password: 'npoc3opDL', method: 'posts/add', url: "www.tripadvisor.com", tags: tags, replace: 'yes'}
                                    );
                                }
                            }); // End update Dummy
                        })
                        .fail (function() {
                            alert("post/add failed");
                        });
                    })
                    .fail(function() {
                        alert("post/get failed");
                    });
                });
                    

                    // var jqxhr = $.get("https://dantsai:npoc3opDL@api.del.icio.us/v1/posts/get?url=" + url, function(data) {
                    //     tags = $(data).contents().contents().attr("tag").replace(/ /g,",");
                    //     // alert("tags before: " + tags);
                    //     tags = tags + "," + trailname + "," + trailname + "-step" + index2; 
                    //     // alert("tags after: " + tags);
                    //     $.get("https://dantsai:npoc3opDL@api.del.icio.us/v1/posts/add?url=" + url + "&tags=" + tags + "&replace=yes", function(data) {
                    //           $("#submitStatus").html("updated!");
                    //     });
                    // });

                // $.getJSON("http://feeds.delicious.com/v2/json/iolab?callback=?", function(data) {
                //     $.each(data, function(index, bookmark) {
                //         // each value is a bookmark
                //         // alert(bookmark.n);
                //         $("#bookmarks").append(generateBookmarkListItem(bookmark));
                //     });
                // });
                event.preventDefault();
            });


            function addLink(url, pathTag) {
                $.getJSON("http://feeds.delicious.com/v2/json/dantsai/"+pathTag+"?callback=?",
                {},
                    function(data){
                        // next is the next Step # for this Path
                        var next = data.length;

                        $.ajax({
                        type: "POST",
                        url: "delicious_proxy.php",
                        data: { username: "dantsai", password: "npoc3opDL", method: "posts/add", url: url, tags: ""+pathTag+","+pathTag+"-step"+next }
                    }).done(function( msg ) {
                        console.log(msg);
                    });
                });
            };
        });

        // Read a page's GET URL variables and return them as an associative array.
        function getUrlVars()
        {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for(var i = 0; i < hashes.length; i++)
            {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }


        var niceTime = (function(){
            var ints = {
                second: 1,
                minute: 60,
                hour: 3600,
                day: 86400,
                week: 604800,
                month: 2592000,
                year: 31536000
            };
            return function(time){
                time = +new Date(time);
                var gap = ((+new Date()) - time) / 1000, amount, measure;
                for (var i in ints){
                    if (gap > ints[i]){ measure = i; }
                }
                amount = gap / ints[measure];
                amount = gap > ints.day ? (Math.round(amount)) : Math.round(amount);
                amount += ' ' + measure + (amount > 1 ? 's' : '') + ' ago';
                return amount;
            };
        })();

    </script>
</head>
<body>
    
    <div id="container">

        <div id="page-header">
            <div id="title"><h1><a href="index.html">The Memex</a><label id="count-label" ></label></h1></div>

        </div>

        <div id="content">
            <ul id="sortable1" class="connectedSort"></ul>
            <ul id="sortable2" class="connectedSort"></ul>

            <div class="ajax-loader">fetching bookmarks...</div>

            <form id="createTrail" action="">
                Trail Name: <input id="trailName" type="text">
                <input id="createTrailButton" type="submit" value="Submit">
            </form>
            <div id="submitStatus"></div>
        </div>



    </div>

</body>
</html>